#include <stdlib.h>
#include <string.h>
#include <sys/time.h>
#include <sys/types.h>

#include "ev.h"

#include "ev_epoll.c"

#define FIND_EVENT(e, fd) {int i; e = NULL;\
  for (i = 0;i < EV_SIZE;i++) {				\
  if ((evs->events[i]).fd == fd) {e = &evs->events[i]; break;}	\
  }}

#define FIND_AND_CHECK(e, i, max, fd) {e = NULL;	\
  for (i = 0;i <= max;i++) {\
  if ((evs->events[i]).fd == fd) {e = &evs->events[i]; break;}}\
  if (e == NULL) return FALSE;}  

#define CHECK_EVENT(e) if (e == NULL) return; 

events_t * ev_create() {
  int i;
  events_t *evs;

  evs = (events_t*)malloc(sizeof(events_t));
  if (evs == NULL) return NULL;
  evs->max = -1;
  evs->started = TRUE;
  if (ev_create_api(evs) == -1) {
    free(evs);
    return NULL;
  }
  for (i = 0;i < EV_SIZE;i++) {
    evs->events[i].fd = -1;
    evs->events[i].mask = EV_NONE;
  }
  return evs;
}

void ev_delete(events_t *evs) {
  if (evs == NULL) return;

  ev_delete_api(evs);
  free(evs);
}

void ev_stop(events_t *evs) {
  if (evs == NULL) return;

  evs->started = FALSE;
}

BOOL ev_create_event(events_t *evs, int fd, int mask, EVPROC *proc, void *tag) {
#ifdef EV_TINY_MODE
  int i;
#endif /*EV_TINY_MODE*/
  event_t *e;

  if (evs == NULL || proc == NULL || tag == NULL) return FALSE;
#ifndef EV_TINY_MODE  
  if (fd >= EV_SIZE) return FALSE;
#endif /*EV_TINY_MODE*/

#ifdef EV_TINY_MODE
  FIND_AND_CHECK(e, i, (EV_SIZE - 1), fd);
#else
  e = &evs->events[fd];
#endif /*EV_TINY_MODE*/
  if (ev_create_event_api(evs, fd, mask) == -1) return FALSE;
  e->mask |= mask;
  if (mask & EV_READ) e->rproc = proc;
  if (mask & EV_WRIT) e->wproc = proc;
  e->tag = tag;
#ifdef EV_TINY_MODE
  if (i > evs->max) evs->max = i;
#else
  if (fd > evs->max) evs->max = fd;
#endif /*EV_TINY_MODE*/
  return TRUE;
}

BOOL ev_delete_event(events_t *evs, int fd, int mask) {
#ifdef EV_TINY_MODE
  int i;
#endif /*EV_TINY_MODE*/
  event_t *e;

  if (evs == NULL) return FALSE;
#ifndef EV_TINY_MODE
  if (fd => EV_SIZE) return FALSE;
#endif /*EV_TINY_MODE*/
  
#ifdef EV_TINY_MODE
  FIND_AND_CHECK(e, i, evs->max, fd);
#else
  e = &evs->events[fd];
#endif /*EV_TINY_MODE*/
  if (e->mask == EV_NONE) return FALSE;
  e->mask = (e->mask & (~mask));
  if (e->mask == EV_NONE) e->fd = -1;
#ifdef EV_TINY_MODE
  if (i == evs->max && e->mask == EV_NONE) {
#else
  if (fd == evs->max && e->mask == EV_NONE) {
#endif
    int j;
    for (j = evs->max - 1;j >= 0;j--) {
      if (evs->events[j].fd != -1) {
	evs->max = j;
	break;
      }
    }
  }
  ev_delete_event_api(evs, fd, mask);
  return TRUE;
}

int ev_get_mask(events_t *evs, int fd) {
#ifdef EV_TINY_MODE
  int i;
#endif /*EV_TINY_MODE*/
  event_t *e;

  if (evs == NULL) return FALSE;
#ifndef EV_TINY_MODE
  if (fd => EV_SIZE) return FALSE;
#endif /*EV_TINY_MODE*/

#ifdef EV_TINY_MODE
  FIND_AND_CHECK(e, i, evs->max, fd);
#else
  e = &evs->events[fd];
#endif /*EV_TINY_MODE*/

  return e->mask;
}

void ev_proc(events_t *evs) {
  int num;

  if (evs == NULL) return 0;

  if (evs->max != -1) {
    int j;
    num = ev_poll_api(evs);
    for (j = 0;j < num;j++) {
      event_t *e = &evs->events[evs->fired[j].index];
      int mask = evs->fired[j].mask;
      int fd = e->fd;
      int rfired = 0;

      if (e->mask & mask & EV_READ) {
	rfired = 1;
	e->rproc(evs, fd, mask, e->tag);
      }
      if (e->mask & mask & EV_WRIT) {
	if (!rfired || e->wproc != e->rproc) 
	  e->wproc(evs, fd, mask, e->tag);
      }
    }
  }
}

void ev_start(events_t *evs) {
  if (evs == NULL) return;
  
  evs->stop = 0;
  while (!evs->stop) {
    ev_proc(evs);
  }
}
